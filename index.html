<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Speed Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #673AB7, #5E35B1);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #666;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .speed-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .connection-type, .speed-status {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-block;
        }

        .connection-type {
            background: #e3f2fd;
            color: #1976D2;
        }

        .speed-status {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* Network Topology Section */
        .topology-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .topology-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .topology-header h2 {
            color: #333;
            font-size: 1.5em;
        }

        .topology-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .topology-wrapper {
            position: relative;
            height: 400px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
            overflow: hidden;
        }

        .network-node {
            position: absolute;
            padding: 10px 15px;
            border-radius: 25px;
            font-weight: 600;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            z-index: 2;
        }

        .node-this-pc {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
        }

        .node-device {
            background: white;
            border: 2px solid #2196F3;
            color: #333;
        }

        .node-router {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .node-offline {
            background: #f5f5f5;
            border: 2px dashed #9E9E9E;
            color: #9E9E9E;
        }

        .connection-line {
            position: absolute;
            background: transparent;
            transform-origin: 0 0;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .connection-good {
            border-bottom: 3px solid #4CAF50;
        }

        .connection-slow {
            border-bottom: 3px solid #FF9800;
        }

        .connection-bad {
            border-bottom: 3px dashed #f44336;
            animation: blink 1s infinite;
        }

        .connection-offline {
            border-bottom: 2px dashed #9E9E9E;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .connection-info {
            position: absolute;
            background: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 3;
        }

        .speed-indicator {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .speed-excellent { background: #4CAF50; }
        .speed-good { background: #8BC34A; }
        .speed-slow { background: #FF9800; }
        .speed-bad { background: #f44336; }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Devices Table Section */
        .devices-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h2 {
            color: #333;
            font-size: 1.5em;
        }

        .table-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .device-count {
            background: #e3f2fd;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            color: #1976D2;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .devices-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .devices-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .devices-table th:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }

        .devices-table th::after {
            content: '‚Üï';
            margin-left: 5px;
            opacity: 0.7;
        }

        .devices-table th.sorted-asc::after {
            content: '‚Üë';
        }

        .devices-table th.sorted-desc::after {
            content: '‚Üì';
        }

        .devices-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9em;
        }

        .devices-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .devices-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .devices-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        .devices-table tbody tr:nth-child(even):hover {
            background-color: #f1f3f4;
        }

        .no-devices {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }

        /* Status badges */
        .status-online {
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-offline {
            background: #f44336;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-unknown {
            background: #FF9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        /* Device type colors */
        .mac-address {
            font-family: 'Courier New', monospace;
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .charts {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .log-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .log {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 10px;
            background: #fafafa;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #4CAF50;
            background: white;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .charts {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .section-header, .topology-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .table-controls, .topology-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .devices-table {
                font-size: 0.8em;
            }
            
            .devices-table th,
            .devices-table td {
                padding: 8px 6px;
            }
            
            .topology-wrapper {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Network Speed Monitor</h1>
            <p>Monitor local network speed and connected devices with real-time topology</p>
        </header>

        <div class="controls">
            <button id="startMonitor" class="btn btn-primary">Start Monitoring</button>
            <button id="speedTest" class="btn btn-secondary">Internet Speed Test</button>
            <button id="scanNetwork" class="btn btn-info">Scan Network</button>
            <button id="detectConnection" class="btn btn-warning">Detect Connection Type</button>
            <button id="exportDevices" class="btn btn-success">Export to CSV</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Local Speed</h3>
                <div id="localSpeed" class="speed-value">0 Mbps</div>
                <div id="connectionType" class="connection-type">-</div>
            </div>
            
            <div class="stat-card">
                <h3>Download</h3>
                <div id="downloadSpeed" class="speed-value">0 Mbps</div>
                <div class="speed-status" id="downloadStatus">-</div>
            </div>
            
            <div class="stat-card">
                <h3>Upload</h3>
                <div id="uploadSpeed" class="speed-value">0 Mbps</div>
                <div class="speed-status" id="uploadStatus">-</div>
            </div>
            
            <div class="stat-card">
                <h3>Network Health</h3>
                <div id="networkHealth" class="speed-value">100%</div>
                <div class="speed-status" id="healthStatus">-</div>
            </div>
        </div>

        <!-- Network Topology Section -->
        <div class="topology-container">
            <div class="topology-header">
                <h2>üåê Network Topology - Real Time</h2>
                <div class="topology-controls">
                    <button id="refreshTopology" class="btn btn-small">Refresh</button>
                    <span class="device-count" id="topologyCount">0 devices</span>
                </div>
            </div>
            
            <div class="topology-wrapper" id="networkTopology">
                <!-- This PC Node -->
                <div class="network-node node-this-pc" id="thisPcNode">
                    üíª This PC<br>
                    <small>192.168.1.100</small>
                </div>
                <!-- Dynamic devices will be added here by JavaScript -->
            </div>
        </div>

        <!-- Devices Table Section -->
        <div class="devices-container">
            <div class="section-header">
                <h2>üìã Connected Devices Details</h2>
                <div class="table-controls">
                    <button id="refreshDevices" class="btn btn-small">Refresh Scan</button>
                    <span class="device-count" id="deviceCount">0 devices found</span>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table id="devicesTable" class="devices-table">
                    <thead>
                        <tr>
                            <th data-sort="hostname">Hostname</th>
                            <th data-sort="ip">IP Address</th>
                            <th data-sort="mac">MAC Address</th>
                            <th data-sort="type">Device Type</th>
                            <th data-sort="currentSpeed">Current Speed</th>
                            <th data-sort="responseTime">Ping (ms)</th>
                            <th data-sort="packetLoss">Packet Loss</th>
                            <th data-sort="connectionQuality">Quality</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="devicesTableBody">
                        <tr>
                            <td colspan="9" class="no-devices">No devices found. Click "Scan Network" to discover devices.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="charts">
            <div class="chart-container">
                <canvas id="speedChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="qualityChart"></canvas>
            </div>
        </div>

        <div class="log-container">
            <h3>Activity Log</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        class NetworkMonitor {
            constructor() {
                this.isMonitoring = false;
                this.monitorInterval = null;
                this.topologyInterval = null;
                this.speedData = {
                    labels: [],
                    local: [],
                    download: [],
                    upload: [],
                    ping: []
                };
                
                this.qualityData = {
                    labels: [],
                    packetLoss: [],
                    connectionQuality: []
                };
                
                this.discoveredDevices = [];
                this.currentSort = { field: 'hostname', direction: 'asc' };
                this.networkHealth = 100;
                
                this.initializeCharts();
                this.setupEventListeners();
                this.scanNetwork(); // Auto-scan on load
            }

            initializeCharts() {
                // Main speed chart
                const speedCtx = document.getElementById('speedChart').getContext('2d');
                this.speedChart = new Chart(speedCtx, {
                    type: 'line',
                    data: {
                        labels: this.speedData.labels,
                        datasets: [
                            {
                                label: 'Local Speed (Mbps)',
                                data: this.speedData.local,
                                borderColor: '#4CAF50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Download (Mbps)',
                                data: this.speedData.download,
                                borderColor: '#2196F3',
                                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Upload (Mbps)',
                                data: this.speedData.upload,
                                borderColor: '#FF9800',
                                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Network Speed - Live Monitoring'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Mbps'
                                }
                            }
                        }
                    }
                });

                // Quality chart
                const qualityCtx = document.getElementById('qualityChart').getContext('2d');
                this.qualityChart = new Chart(qualityCtx, {
                    type: 'line',
                    data: {
                        labels: this.qualityData.labels,
                        datasets: [
                            {
                                label: 'Packet Loss (%)',
                                data: this.qualityData.packetLoss,
                                borderColor: '#f44336',
                                backgroundColor: 'rgba(244, 67, 54, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Connection Quality (%)',
                                data: this.qualityData.connectionQuality,
                                borderColor: '#4CAF50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Network Quality Metrics'
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Packet Loss %'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Quality %'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }

            setupEventListeners() {
                document.getElementById('startMonitor').addEventListener('click', () => {
                    this.toggleMonitoring();
                });

                document.getElementById('speedTest').addEventListener('click', () => {
                    this.runSpeedTest();
                });

                document.getElementById('scanNetwork').addEventListener('click', () => {
                    this.scanNetwork();
                });

                document.getElementById('detectConnection').addEventListener('click', () => {
                    this.detectConnectionType();
                });

                document.getElementById('refreshDevices').addEventListener('click', () => {
                    this.scanNetwork();
                });

                document.getElementById('exportDevices').addEventListener('click', () => {
                    this.exportToCSV();
                });

                document.getElementById('refreshTopology').addEventListener('click', () => {
                    this.scanNetwork();
                });

                // Table sorting
                document.querySelectorAll('#devicesTable th[data-sort]').forEach(th => {
                    th.addEventListener('click', () => {
                        this.sortTable(th.dataset.sort);
                    });
                });
            }

            toggleMonitoring() {
                if (this.isMonitoring) {
                    this.stopMonitoring();
                } else {
                    this.startMonitoring();
                }
            }

            startMonitoring() {
                this.isMonitoring = true;
                document.getElementById('startMonitor').textContent = 'Stop Monitoring';
                document.getElementById('startMonitor').classList.add('btn-danger');
                
                this.log('Live monitoring started...');
                
                this.monitorInterval = setInterval(() => {
                    this.updateLocalSpeed();
                    this.updateDeviceSpeeds();
                    this.updateTopology();
                    this.updateCharts();
                }, 2000);

                this.topologyInterval = setInterval(() => {
                    this.updateTopologyConnections();
                }, 1000);
            }

            stopMonitoring() {
                this.isMonitoring = false;
                document.getElementById('startMonitor').textContent = 'Start Monitoring';
                document.getElementById('startMonitor').classList.remove('btn-danger');
                
                this.log('Monitoring stopped');
                
                if (this.monitorInterval) {
                    clearInterval(this.monitorInterval);
                }
                if (this.topologyInterval) {
                    clearInterval(this.topologyInterval);
                }
            }

            async updateLocalSpeed() {
                try {
                    // Simulate local speed measurement
                    const localSpeed = Math.random() * 1000;
                    const timestamp = new Date().toLocaleTimeString();
                    
                    document.getElementById('localSpeed').textContent = localSpeed.toFixed(2) + ' Mbps';
                    
                    // Update chart data
                    this.speedData.labels.push(timestamp);
                    this.speedData.local.push(localSpeed);
                    
                    // Keep only last 20 data points
                    if (this.speedData.labels.length > 20) {
                        this.speedData.labels.shift();
                        this.speedData.local.shift();
                        this.speedData.download.shift();
                        this.speedData.upload.shift();
                        this.speedData.ping.shift();
                    }
                    
                } catch (error) {
                    this.log('Error measuring local speed: ' + error.message);
                }
            }

            updateDeviceSpeeds() {
                // Update real-time speeds for all devices
                this.discoveredDevices.forEach(device => {
                    if (device.status === 'online') {
                        // Simulate network conditions
                        const packetLoss = Math.random() * 10; // 0-10% packet loss
                        const speedVariance = Math.random() * 0.3 + 0.7; // 70-100% of max speed
                        
                        // Calculate current speed based on connection type and conditions
                        let maxSpeed = 1000; // Default Gigabit
                        if (device.connectionType === '100') maxSpeed = 100;
                        if (device.connectionType === '10') maxSpeed = 10;
                        
                        const currentSpeed = maxSpeed * speedVariance * (1 - packetLoss/100);
                        const responseTime = 10 + (packetLoss * 5); // Base 10ms + packet loss impact
                        
                        device.currentSpeed = currentSpeed;
                        device.packetLoss = packetLoss;
                        device.responseTime = responseTime;
                        device.connectionQuality = 100 - packetLoss;
                        
                        // Detect connection issues
                        if (packetLoss > 5) {
                            device.connectionIssue = 'High packet loss';
                        } else if (currentSpeed < maxSpeed * 0.5) {
                            device.connectionIssue = 'Slow connection';
                        } else {
                            device.connectionIssue = null;
                        }
                    }
                });
                
                this.updateNetworkHealth();
                this.displayDevicesTable(this.discoveredDevices);
            }

            updateNetworkHealth() {
                let totalQuality = 0;
                let onlineDevices = 0;
                
                this.discoveredDevices.forEach(device => {
                    if (device.status === 'online') {
                        totalQuality += device.connectionQuality || 100;
                        onlineDevices++;
                    }
                });
                
                this.networkHealth = onlineDevices > 0 ? totalQuality / onlineDevices : 100;
                
                document.getElementById('networkHealth').textContent = this.networkHealth.toFixed(1) + '%';
                
                // Update health status
                const healthElement = document.getElementById('healthStatus');
                if (this.networkHealth >= 90) {
                    healthElement.textContent = 'Excellent';
                    healthElement.style.color = '#4CAF50';
                } else if (this.networkHealth >= 70) {
                    healthElement.textContent = 'Good';
                    healthElement.style.color = '#8BC34A';
                } else if (this.networkHealth >= 50) {
                    healthElement.textContent = 'Fair';
                    healthElement.style.color = '#FF9800';
                } else {
                    healthElement.textContent = 'Poor';
                    healthElement.style.color = '#f44336';
                }

                // Update quality chart
                const timestamp = new Date().toLocaleTimeString();
                this.qualityData.labels.push(timestamp);
                this.qualityData.packetLoss.push(100 - this.networkHealth);
                this.qualityData.connectionQuality.push(this.networkHealth);
                
                if (this.qualityData.labels.length > 20) {
                    this.qualityData.labels.shift();
                    this.qualityData.packetLoss.shift();
                    this.qualityData.connectionQuality.shift();
                }
            }

            // ... rest of the methods (scanNetwork, performNetworkScan, etc.) remain similar but updated for new fields

            displayDevicesTable(devices) {
                const tbody = document.getElementById('devicesTableBody');
                
                if (devices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="no-devices">No devices found on the network.</td></tr>';
                    return;
                }
                
                const sortedDevices = this.sortDevices(devices, this.currentSort.field, this.currentSort.direction);
                
                tbody.innerHTML = sortedDevices.map(device => {
                    const speedClass = this.getSpeedClass(device.currentSpeed, device.connectionType);
                    const qualityClass = this.getQualityClass(device.connectionQuality);
                    
                    return '<tr class="type-' + device.type + '">' +
                           '<td><strong>' + device.hostname + '</strong>' + 
                           (device.connectionIssue ? '<br><small style="color: #f44336;">‚ö† ' + device.connectionIssue + '</small>' : '') + '</td>' +
                           '<td>' + device.ip + '</td>' +
                           '<td><span class="mac-address">' + device.mac + '</span></td>' +
                           '<td>' + this.capitalizeFirstLetter(device.type) + '<br><small>' + (device.connectionType || 'Auto') + '</small></td>' +
                           '<td><span class="' + speedClass + '">' + (device.currentSpeed ? device.currentSpeed.toFixed(1) + ' Mbps' : '-') + '</span></td>' +
                           '<td>' + (device.responseTime ? device.responseTime.toFixed(1) + ' ms' : '-') + '</td>' +
                           '<td>' + (device.packetLoss ? device.packetLoss.toFixed(1) + '%' : '-') + '</td>' +
                           '<td><span class="' + qualityClass + '">' + (device.connectionQuality ? device.connectionQuality.toFixed(0) + '%' : '-') + '</span></td>' +
                           '<td><span class="status-' + device.status + '">' + device.status.toUpperCase() + '</span></td>' +
                           '</tr>';
                }).join('');
            }

            getSpeedClass(speed, connectionType) {
                if (!speed) return '';
                const maxSpeed = connectionType === '10' ? 10 : connectionType === '100' ? 100 : 1000;
                const percentage = (speed / maxSpeed) * 100;
                
                if (percentage >= 80) return 'speed-excellent';
                if (percentage >= 50) return 'speed-good';
                if (percentage >= 20) return 'speed-slow';
                return 'speed-bad';
            }

            getQualityClass(quality) {
                if (!quality) return '';
                if (quality >= 90) return 'speed-excellent';
                if (quality >= 70) return 'speed-good';
                if (quality >= 50) return 'speed-slow';
                return 'speed-bad';
            }

            updateTopology() {
                const topologyContainer = document.getElementById('networkTopology');
                
                // Clear existing device nodes (keep This PC node)
                const existingNodes = topologyContainer.querySelectorAll('.network-node:not(.node-this-pc)');
                existingNodes.forEach(node => node.remove());
                
                // Clear existing connections
                const existingConnections = topologyContainer.querySelectorAll('.connection-line, .connection-info, .speed-indicator');
                existingConnections.forEach(conn => conn.remove());
                
                // Add device nodes
                const thisPcRect = document.getElementById('thisPcNode').getBoundingClientRect();
                const containerRect = topologyContainer.getBoundingClientRect();
                
                const thisPcX = thisPcRect.left - containerRect.left + thisPcRect.width / 2;
                const thisPcY = thisPcRect.top - containerRect.top + thisPcRect.height / 2;
                
                this.discoveredDevices.forEach((device, index) => {
                    if (device.ip === '192.168.1.1') return; // Skip router for now
                    
                    const angle = (index / this.discoveredDevices.length) * Math.PI * 1.5 + Math.PI/4;
                    const radius = 200;
                    const x = thisPcX + Math.cos(angle) * radius;
                    const y = thisPcY + Math.sin(angle) * radius;
                    
                    const node = document.createElement('div');
                    node.className = `network-node node-device ${device.status === 'offline' ? 'node-offline' : ''} ${device.type === 'router' ? 'node-router' : ''}`;
                    node.style.left = (x - 60) + 'px';
                    node.style.top = (y - 20) + 'px';
                    node.innerHTML = `${this.getDeviceIcon(device.type)} ${device.hostname}<br><small>${device.ip}</small>`;
                    node.id = 'node-' + device.ip.replace(/\./g, '-');
                    
                    topologyContainer.appendChild(node);
                });
                
                this.updateTopologyConnections();
            }

            updateTopologyConnections() {
                const topologyContainer = document.getElementById('networkTopology');
                const thisPcRect = document.getElementById('thisPcNode').getBoundingClientRect();
                const containerRect = topologyContainer.getBoundingClientRect();
                
                const thisPcX = thisPcRect.left - containerRect.left + thisPcRect.width / 2;
                const thisPcY = thisPcRect.top - containerRect.top + thisPcRect.height / 2;
                
                this.discoveredDevices.forEach(device => {
                    if (device.ip === '192.168.1.1') return;
                    
                    const deviceNode = document.getElementById('node-' + device.ip.replace(/\./g, '-'));
                    if (!deviceNode) return;
                    
                    const deviceRect = deviceNode.getBoundingClientRect();
                    const deviceX = deviceRect.left - containerRect.left + deviceRect.width / 2;
                    const deviceY = deviceRect.top - containerRect.top + deviceRect.height / 2;
                    
                    // Remove existing connection for this device
                    const existingConn = topologyContainer.querySelector('.connection-line[data-device="' + device.ip + '"]');
                    if (existingConn) existingConn.remove();
                    
                    // Create new connection line
                    const connection = document.createElement('div');
                    connection.className = 'connection-line';
                    connection.setAttribute('data-device', device.ip);
                    
                    const length = Math.sqrt(Math.pow(deviceX - thisPcX, 2) + Math.pow(deviceY - thisPcY, 2));
                    const angle = Math.atan2(deviceY - thisPcY, deviceX - thisPcX) * 180 / Math.PI;
                    
                    connection.style.width = length + 'px';
                    connection.style.left = thisPcX + 'px';
                    connection.style.top = thisPcY + 'px';
                    connection.style.transform = 'rotate(' + angle + 'deg)';
                    
                    // Set connection style based on quality
                    if (device.status === 'offline') {
                        connection.classList.add('connection-offline');
                    } else if (device.packetLoss > 5) {
                        connection.classList.add('connection-bad');
                    } else if (device.currentSpeed < 100) {
                        connection.classList.add('connection-slow');
                    } else {
                        connection.classList.add('connection-good');
                    }
                    
                    topologyContainer.appendChild(connection);
                    
                    // Add speed indicator
                    if (device.status === 'online') {
                        const indicator = document.createElement('div');
                        indicator.className = `speed-indicator ${this.getSpeedClass(device.currentSpeed, device.connectionType)}`;
                        indicator.style.left = (thisPcX + (deviceX - thisPcX) * 0.7 - 4) + 'px';
                        indicator.style.top = (thisPcY + (deviceY - thisPcY) * 0.7 - 4) + 'px';
                        topologyContainer.appendChild(indicator);
                        
                        // Add connection info
                        const info = document.createElement('div');
                        info.className = 'connection-info';
                        info.style.left = (thisPcX + (deviceX - thisPcX) * 0.5 - 40) + 'px';
                        info.style.top = (thisPcY + (deviceY - thisPcY) * 0.5 - 15) + 'px';
                        info.innerHTML = `${device.currentSpeed ? device.currentSpeed.toFixed(0) : '0'} Mbps<br>${device.packetLoss ? device.packetLoss.toFixed(1) : '0'}% loss`;
                        topologyContainer.appendChild(info);
                    }
                });
            }

            getDeviceIcon(type) {
                const icons = {
                    computer: 'üíª',
                    phone: 'üì±',
                    router: 'üì°',
                    tablet: 'üìü',
                    iot: 'üîå',
                    printer: 'üñ®Ô∏è'
                };
                return icons[type] || 'üîò';
            }

            // ... rest of the existing methods remain the same

        }

        // Initialize application when page loads
        document.addEventListener('DOMContentLoaded', function() {
            new NetworkMonitor();
        });
    </script>
</body>
</html>
